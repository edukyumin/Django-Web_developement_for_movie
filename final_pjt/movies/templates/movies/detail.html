{% extends 'base.html' %}

{% block content %}
<a href="{% url 'movies:index' %}"><뒤로가기</a>
<h1>Movie Detail</h1>

<div class="d-flex justify-content-end">
  <a href="{% url 'movies:create' movie.pk %}" class="btn btn-primary float-right">리뷰 작성 </a>
</div>

<!--좋아요-->
    {% if user in movie.like_users.all %}
      <i class="fas fa-heart fa-lg like-button" style="color:crimson" data-pk="{{ movie.pk }}"></i>
    {% else %}
      <i class="fas fa-heart fa-lg like-button" style="color:black" data-pk="{{ movie.pk }}"></i>
    {% endif %}
      <span id="like-count-{{ movie.pk }}">{{ movie.like_users.all|length }}</span> 명이 이 영화를 좋아합니다.
<hr>

<div class="card text-center">
  <div class="card-header text-info">{{ movie.title }}</div>
  <div class="card-body">
    <h5 class="card-title"></h5>
    <p class="card-text">
    	<img src="https://image.tmdb.org/t/p/w780/{{ movie.backdrop_path }}" alt="poster" style="width:300px; height: 300px;">
    	</br>
    </p>
    <h6 class="text-danger">Genres :
    {% for genre in genres %}
    <span>{{ genre.name }}</span>
    {% endfor %}
    </h6>
  </div>
</div>


<table class="table table-striped">
  <thead>
    <tr>
      <th scope="col">Reviews</th>
      <th scope="col">Title</th>
      <th scope="col">Content</th>
      <th scope="col">Created by</th>

    </tr>
  </thead>
  <tbody>
    {% for review in reviews %}
    <tr>
    	<th scope="row">{{ forloop.counter }}</th>
    	<td><a href="{% url 'movies:review_detail' movie.pk review.pk %}">{{ review.title }}</a></td>
    	<td>{{ review.content }}</td>
		<td><a href="{% url 'accounts:profile' review.user.username %}">{{ review.user.username }}</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% if movie.user == request.user %}
<div class="d-flex justify-content-between my-3">
<a href="{% url 'movies:movie_update' movie.pk review.pk %}" class="btn btn-primary">수정하기</a>
<form action="{% url 'movies:movie_delete' movie.pk review.pk %}" method="POST">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger">삭제하기</button>
</form>
</div>
{% endif %}


{% if review.user == request.user %}
<div class="d-flex justify-content-between my-3">
<a href="{% url 'movies:update' movie.pk review.pk %}" class="btn btn-primary">수정하기</a>
<form action="{% url 'movies:delete' movie.pk review.pk %}" method="POST">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger">삭제하기</button>
</form>
</div>
{% endif %}




<script>
    // 1. 좋아요 하트 모두 가져오기
    const likeButtonList = document.querySelectorAll('.like-button')

    // 2. 각각의 좋아요 하트에 이벤트리스너 추가
    likeButtonList.forEach(likeButton => {
      likeButton.addEventListener('click', function(event) {
        console.log(event)
 
        const moviePk = event.target.dataset.pk

        // 4. 좋아요 함수에 요청 보내기
        {% if user.is_authenticated %}
          axios.get(`/movies/${moviePk}/like/`)
            .then(response => {
              // console.log(response)
              // 4-1. 좋아요 카운트 변경
              document.querySelector(`#like-count-${moviePk}`).innerText = response.data.count
              // 4-2. 좋아요 하트 색깔 변경
              if (response.data.liked) {
                event.target.style.color = 'crimson'
              } else {
                event.target.style.color = 'black'
              }
            })
            .catch(error => {
              console.log(error)
            })
          {% else %}
            alert('비로그인 사용자는 좋아요를 누를 수 없어요!')
          {% endif %}
      })
    })
</script>

{% endblock %}